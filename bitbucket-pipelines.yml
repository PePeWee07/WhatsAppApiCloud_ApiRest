image: docker:20.10.24

pipelines:
  branches:
    main:
      - step:
          name: Build & Push Docker Image
          runs-on:
            - self.hosted
            - linux
          services:
            - docker
          caches:
            - docker
          script:
            - echo "Building Docker image"
            - docker build -t pepewee/whatsapp-api-cloud:$VERSION .
            - docker tag pepewee/whatsapp-api-cloud:$VERSION pepewee/whatsapp-api-cloud:latest
            - echo "Logging in to Docker Hub"
            - echo $DOCKER_HUB_TOKEN | docker login -u $DOCKER_HUB_USER --password-stdin
            - echo "Pushing image to Docker Hub"
            - docker push pepewee/whatsapp-api-cloud:$VERSION
            - docker push pepewee/whatsapp-api-cloud:latest

      - step:
          name: Deploy to Server
          runs-on:
            - self.hosted
            - linux
          script:
            - pipe: atlassian/ssh-run:0.8.1
              variables:
                SSH_USER: "$SSH_USER"
                SERVER: "$SSH_HOST"
                SSH_KEY: "$SSH_KEY"
                COMMAND: >
                  set -e &&
                  echo "$DOCKER_HUB_TOKEN" > /tmp/token.txt &&
                  cat /tmp/token.txt | docker login -u "$DOCKER_HUB_USER" --password-stdin &&
                  docker pull pepewee/whatsapp-api-cloud:latest &&
                  docker-compose -f /data/sites/ia-sp-backoffice.ucatolica.cue.ec/html/back-end/docker-compose.yml down &&
                  sleep 3 &&
                  echo "Eliminando contenedor whatsapp-api-cloud-db..." &&
                  (docker inspect -f '{{.State.Status}}' whatsapp-api-cloud-db && docker rm -f whatsapp-api-cloud-db && docker wait whatsapp-api-cloud-db) || echo "Contenedor db ya no existe o no se puede eliminar." &&
                  echo "Eliminando contenedor whatsapp-api-cloud-app..." &&
                  (docker inspect -f '{{.State.Status}}' whatsapp-api-cloud-app && docker rm -f whatsapp-api-cloud-app && docker wait whatsapp-api-cloud-app) || echo "Contenedor app ya no existe o no se puede eliminar." &&
                  sleep 3 &&
                  echo "Lanzando servicios nuevamente..." &&
                  docker-compose -f /data/sites/ia-sp-backoffice.ucatolica.cue.ec/html/back-end/docker-compose.yml up -d --force-recreate --remove-orphans

definitions:
  services:
    docker:
      memory: 2048
